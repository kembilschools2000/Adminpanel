<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kembil Admin Dashboard</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-storage-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f7fc;
      margin: 0;
      padding: 0;
    }
    header {
      background: #004aad;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
    }
    nav {
      display: flex;
      background: #0d47a1;
    }
    nav button {
      flex: 1;
      padding: 1rem;
      background: #0d47a1;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s;
    }
    nav button:hover,
    nav button.active {
      background: #002171;
    }
    section.content {
      padding: 2rem;
      background: white;
      margin: 1rem 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
      display: none;
    }
    section.content.active {
      display: block;
    }
    form label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
    }
    form input,
    form select,
    form textarea {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    form button {
      margin-top: 1.5rem;
      background: #004aad;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }
    form button:hover {
      background: #002171;
    }
    .status {
      margin-top: 0.75rem;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <header>Kembil Admin Dashboard</header>

  <nav>
    <button class="nav-btn active" data-target="addStudent">Add New Student</button>
    <button class="nav-btn" data-target="results">Results Handling</button>
    <button class="nav-btn" data-target="payments">Payments</button>
    <button class="nav-btn" data-target="announcements">Announcements</button>
    <button class="nav-btn" data-target="studentFiles">Student Files</button>
  </nav>

  <!-- Add Student -->
  <section id="addStudent" class="content active">
    <h2>Add New Student</h2>
    <form id="addStudentForm">
      <label>Full Name</label>
      <input type="text" id="studentName" required>

      <label>Class</label>
      <select id="studentClass" required>
        <option value="">Select Class</option>
        <option>JSS1</option><option>JSS2</option><option>JSS3</option>
        <option>SS1</option><option>SS2</option><option>SS3</option>
      </select>

      <label>Email</label>
      <input type="email" id="studentEmail" required>

      <label>Password</label>
      <input type="text" id="studentPassword" required>

      <button type="submit">Add Student</button>
    </form>
    <p id="addStudentStatus" class="status"></p>
  </section>

  <!-- Results Handling -->
  <section id="results" class="content">
    <h2>Results Handling</h2>

    <form id="resultsSelectorForm">
      <label>Student Name</label>
      <input type="text" id="resStudentName" required>

      <label>Student Email</label>
      <input type="email" id="resStudentEmail" required>

      <label>Class</label>
      <select id="resClass" required>
        <option value="">Select Class</option>
        <option>JSS1</option><option>JSS2</option><option>JSS3</option>
        <option>SS1</option><option>SS2</option><option>SS3</option>
      </select>

      <label>Term</label>
      <select id="resTerm" required>
        <option>First Term</option>
        <option>Second Term</option>
        <option>Third Term</option>
      </select>

      <label>Session</label>
      <input type="text" id="resSession" placeholder="2025/2026" required>

      <button type="submit">Load Subjects</button>
    </form>

    <div id="resultsTableContainer" style="margin-top:20px; display:none;">
      <table id="resultsTable" border="1" cellspacing="0" cellpadding="8" width="100%">
        <thead style="background:#004aad;color:white;">
          <tr><th>Subject</th><th>Score</th><th>Grade</th></tr>
        </thead>
        <tbody id="resultsTableBody"></tbody>
      </table>

      <button id="saveResultsBtn">Save Results</button>
      <p id="resultsStatus" class="status"></p>
    </div>
  </section>

  <!-- Payments -->
  <section id="payments" class="content">
    <h2>Payments</h2>

    <form id="paymentsForm">
      <label>Student Name</label>
      <input type="text" id="payStudentName" required>

      <label>Student Email</label>
      <input type="email" id="payStudentEmail" required>

      <label>Class</label>
      <select id="payClass" required>
        <option value="">Select Class</option>
        <option>JSS1</option><option>JSS2</option><option>JSS3</option>
        <option>SS1</option><option>SS2</option><option>SS3</option>
      </select>

      <label>Payment Type</label>
      <select id="payType" required>
        <option value="">Select Payment Type</option>
        <option>Tuition</option><option>PTA</option>
        <option>Uniform</option><option>Exam Fee</option>
      </select>

      <label>Amount (‚Ç¶)</label>
      <input type="number" id="payAmount" required>

      <label>Term</label>
      <select id="payTerm" required>
        <option>First Term</option><option>Second Term</option><option>Third Term</option>
      </select>

      <label>Session</label>
      <input type="text" id="paySession" placeholder="2025/2026" required>

      <button type="submit">Record Payment</button>
    </form>

    <p id="paymentStatus" class="status"></p>
  </section>

  <!-- Announcements -->
  <section id="announcements" class="content">
    <h2>Announcements</h2>

    <form id="announcementsForm">
      <label>Title</label>
      <input type="text" id="announceTitle" required>

      <label>Message</label>
      <textarea id="announceMessage" rows="4" required></textarea>

      <button type="submit">Post Announcement</button>
    </form>

    <p id="announceStatus" class="status"></p>

    <h3>Recent Announcements</h3>
    <ul id="announcementList"></ul>
  </section>

  <!-- Student Files -->
  <section id="studentFiles" class="content">
    <h2>Upload Student Files</h2>

    <input type="text" id="studentFileId" placeholder="Student ID or Email">
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">Upload File</button>

    <h3>Uploaded Files</h3>
    <ul id="fileList"></ul>
  </section>

  <!-- SCRIPT -->
  <script>
    /* Navigation */
    const navButtons = document.querySelectorAll("nav button.nav-btn");
    const sections = document.querySelectorAll("section.content");

    navButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        navButtons.forEach(b => b.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));

        btn.classList.add("active");
        document.getElementById(btn.dataset.target).classList.add("active");
      });
    });

    /* Firebase Setup */
    firebase.initializeApp({
      apiKey: "AIzaSyDtvLEYFnNmmge6WYTrlrO2BTtkqgBWYxg",
      authDomain: "kembil-schools.firebaseapp.com",
      projectId: "kembil-schools",
      storageBucket: "kembil-schools.appspot.com",
      messagingSenderId: "897542186994",
      appId: "1:897542186994:web:36282b2f8729065edcad6b"
    });

    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    /* Add Student */
    const addStudentForm = document.getElementById("addStudentForm");
    const addStudentStatus = document.getElementById("addStudentStatus");

    addStudentForm.addEventListener("submit", e => {
      e.preventDefault();

      const name = studentName.value.trim();
      const email = studentEmail.value.trim();
      const password = studentPassword.value.trim();
      const cls = studentClass.value;

      if (!name || !email || !password || !cls) {
        addStudentStatus.textContent = "‚ùå Please fill all fields.";
        addStudentStatus.style.color = "red";
        return;
      }

      addStudentStatus.textContent = "Creating student...";

      auth.createUserWithEmailAndPassword(email, password)
        .then(u => db.collection("students")
          .doc(u.user.uid)
          .set({
            name,
            email,
            class: cls,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          })
        )
        .then(() => {
          addStudentStatus.textContent = "‚úÖ Student created successfully!";
          addStudentStatus.style.color = "green";
          addStudentForm.reset();
        })
        .catch(err => {
          addStudentStatus.textContent = "‚ùå " + err.message;
          addStudentStatus.style.color = "red";
        });
    });

    /* SUBJECTS */
    const subjectsByClass = {
      JSS1:["Mathematics","English","Basic Science","Basic Tech","Information Technology","Business Studies","Social Studies","C.R.S","Civic Education","Home Economics","French","Yoruba","Art"],
      JSS2:["Mathematics","English","Basic Science","Basic Tech","Information Technology","Business Studies","Social Studies","C.R.S","Civic Education","Home Economics","French","Yoruba","Art"],
      JSS3:["Mathematics","English","Basic Science","Basic Tech","Information Technology","Business Studies","Social Studies","C.R.S","Civic Education","Home Economics","French","Yoruba","Art"],

      SS1:["Maths","English","Biology","Chemistry","Physics","Further Maths","Economics","Accounting","C.R.K","Yoruba","Commerce","Government","Literature"],
      SS2:["Maths","English","Biology","Chemistry","Physics","Further Maths","Economics","Accounting","C.R.K","Yoruba","Commerce","Government","Literature"],
      SS3:["Maths","English","Biology","Chemistry","Physics","Further Maths","Economics","Accounting","C.R.K","Yoruba","Commerce","Government","Literature"]
    };

    /* Load Subjects */
    const resultsSelectorForm = document.getElementById("resultsSelectorForm");
    const resultsTableContainer = document.getElementById("resultsTableContainer");
    const resultsTableBody = document.getElementById("resultsTableBody");

    resultsSelectorForm.addEventListener("submit", e => {
      e.preventDefault();

      const cls = resClass.value;
      const subs = subjectsByClass[cls] || [];

      resultsTableBody.innerHTML = "";
      resultsTableContainer.style.display = "none";

      if (subs.length === 0) {
        resultsStatus.textContent = "‚ùå Select a valid class.";
        resultsStatus.style.color = "red";
        return;
      }

      subs.forEach(sub => {
        const tr = document.createElement("tr");

        const subjCell = document.createElement("td");
        subjCell.textContent = sub;

        const scoreCell = document.createElement("td");
        const scoreInput = document.createElement("input");
        scoreInput.type = "number";
        scoreInput.classList.add("scoreInput");
        scoreInput.min = 0;
        scoreInput.max = 100;
        scoreCell.appendChild(scoreInput);

        const gradeCell = document.createElement("td");
        gradeCell.textContent = "‚Äì";

        scoreInput.addEventListener("input", () => {
          const score = parseFloat(scoreInput.value);
          if (isNaN(score)) {
            gradeCell.textContent = "‚Äì";
            return;
          }
          gradeCell.textContent =
            score >= 70 ? "A" :
            score >= 60 ? "B" :
            score >= 50 ? "C" :
            score >= 45 ? "D" :
            score >= 40 ? "E" : "F";
        });

        tr.appendChild(subjCell);
        tr.appendChild(scoreCell);
        tr.appendChild(gradeCell);
        resultsTableBody.appendChild(tr);
      });

      resultsStatus.textContent = "";
      resultsTableContainer.style.display = "block";
    });

    /* Save Results */
    const saveResultsBtn = document.getElementById("saveResultsBtn");

    saveResultsBtn.addEventListener("click", async () => {
      const name = resStudentName.value.trim();
      const email = resStudentEmail.value.trim();
      const cls = resClass.value;
      const term = resTerm.value;
      const sessionRaw = resSession.value.trim();
      const session = sessionRaw.replace(/\//g, "_");

      if (!name || !email || !cls || !term || !sessionRaw) {
        resultsStatus.textContent = "‚ùå Fill all form fields.";
        resultsStatus.style.color = "red";
        return;
      }

      const data = [];
      document.querySelectorAll(".scoreInput").forEach(input => {
        const row = input.parentElement.parentElement; /* FIX */
        const subj = row.cells[0].textContent;
        const score = parseFloat(input.value);

        if (!isNaN(score)) {
          const grade =
            score >= 70 ? "A" :
            score >= 60 ? "B" :
            score >= 50 ? "C" :
            score >= 45 ? "D" :
            score >= 40 ? "E" : "F";

          data.push({ subject: subj, score, grade });
        }
      });

      if (data.length === 0) {
        resultsStatus.textContent = "‚ùå Enter at least one score.";
        resultsStatus.style.color = "red";
        return;
      }

      resultsStatus.textContent = "Saving...";
      resultsStatus.style.color = "black";

      try {
        const snap = await db.collection("students")
          .where("name","==",name)
          .where("email","==",email)
          .get();

        if (snap.empty) {
          resultsStatus.textContent = "‚ùå Student not found.";
          resultsStatus.style.color = "red";
          return;
        }

        const uid = snap.docs[0].id;

        await db.collection("students")
          .doc(uid)
          .collection("results")
          .doc(`${session}_${term}`)
          .set({
            studentName: name,
            class: cls,
            term,
            session: sessionRaw,
            records: data,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        resultsStatus.textContent = "‚úÖ Results saved!";
        resultsStatus.style.color = "green";
        resultsSelectorForm.reset();
        resultsTableContainer.style.display = "none";
      } catch (err) {
        resultsStatus.textContent = "‚ùå " + err.message;
        resultsStatus.style.color = "red";
      }
    });

    /* Payments */
    const paymentsForm = document.getElementById("paymentsForm");
    const paymentStatus = document.getElementById("paymentStatus");

    paymentsForm.addEventListener("submit", async e => {
      e.preventDefault();

      paymentStatus.textContent = "Processing...";

      const name = payStudentName.value.trim();
      const email = payStudentEmail.value.trim();
      const cls = payClass.value;
      const type = payType.value;
      const amount = parseFloat(payAmount.value);
      const term = payTerm.value;
      const sessionRaw = paySession.value.trim();
      const session = sessionRaw.replace(/\//g, "_");

      if (!name || !email || !cls || !type || !sessionRaw || isNaN(amount)) {
        paymentStatus.textContent = "‚ùå Fill all fields.";
        paymentStatus.style.color = "red";
        return;
      }

      const paymentData = {
        studentName: name,
        studentEmail: email,
        class: cls,
        paymentType: type,
        amount,
        term,
        session: sessionRaw,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        const snap = await db.collection("students")
          .where("name","==",name)
          .where("email","==",email)
          .get();

        if (snap.empty) {
          paymentStatus.textContent = "‚ùå Student not found.";
          paymentStatus.style.color = "red";
          return;
        }

        const uid = snap.docs[0].id;

        await db.collection("students").doc(uid).collection("payments").add(paymentData);
        await db.collection("payments").add({ ...paymentData, studentId: uid });

        paymentStatus.textContent = "‚úÖ Payment recorded!";
        paymentStatus.style.color = "green";
        paymentsForm.reset();
      } catch (err) {
        paymentStatus.textContent = "‚ùå " + err.message;
        paymentStatus.style.color = "red";
      }
    });

    /* Announcements */
    const announcementsForm = document.getElementById("announcementsForm");

    announcementsForm.addEventListener("submit", async e => {
      e.preventDefault();

      const title = announceTitle.value.trim();
      const msg = announceMessage.value.trim();

      if (!title || !msg) {
        announceStatus.textContent = "‚ùå Fill all fields.";
        announceStatus.style.color = "red";
        return;
      }

      announceStatus.textContent = "Posting...";

      try {
        await db.collection("announcements").add({
          title,
          message: msg,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        announceStatus.textContent = "‚úÖ Posted!";
        announceStatus.style.color = "green";
        announcementsForm.reset();
      } catch (err) {
        announceStatus.textContent = "‚ùå " + err.message;
        announceStatus.style.color = "red";
      }
    });

/* Announcements Listener WITH DELETE */
db.collection("announcements")
  .orderBy("timestamp", "desc")
  .limit(10)
  .onSnapshot(snapshot => {
    announcementList.innerHTML = "";

    if (snapshot.empty) {
      announcementList.innerHTML = "<li>No announcements yet.</li>";
      return;
    }

    snapshot.forEach(doc => {
      const a = doc.data();
      const id = doc.id;
      const date = a.timestamp ? a.timestamp.toDate().toLocaleString() : "Now";

      const li = document.createElement("li");
      li.style.border = "1px solid #ddd";
      li.style.padding = "10px";
      li.style.marginBottom = "10px";
      li.style.borderRadius = "6px";
      li.style.position = "relative";
      
      li.innerHTML = `
        <strong>${a.title}</strong>
        <span style="position:absolute; right:10px; top:10px; cursor:pointer; font-size:18px; color:#c00;"
              onclick="deleteAnnouncement('${id}')">üóëÔ∏è</span>
        <br>
        <small>${date}</small><br>
        <p>${a.message}</p>
      `;

      announcementList.appendChild(li);
    });
  });

/* Delete Announcement */
async function deleteAnnouncement(id) {
  const sure = confirm("Delete this announcement?");
  if (!sure) return;

  try {
    await db.collection("announcements").doc(id).delete();
    console.log("Announcement deleted:", id);
  } catch (err) {
    alert("Error deleting announcement: " + err.message);
  }
}

    /* Upload Student Files */
    const studentFileId = document.getElementById("studentFileId");
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");

    async function uploadFile() {
      const id = studentFileId.value.trim();
      const file = fileInput.files[0];

      if (!id || !file) {
        alert("Enter student ID and choose a file.");
        return;
      }

      const path = `studentFiles/${id}/${file.name}`;
      const ref = storage.ref(path);

      try {
        await ref.put(file);
        alert("‚úÖ File uploaded!");
        loadFiles(id);
      } catch (err) {
        alert("‚ùå " + err.message);
      }
    }

    async function loadFiles(id) {
      fileList.innerHTML = "Loading...";

      const folder = storage.ref(`studentFiles/${id}`);

      try {
        const items = await folder.listAll();
        fileList.innerHTML = "";

        if (items.items.length === 0) {
          fileList.innerHTML = "<li>No files uploaded yet.</li>";
          return;
        }

        for (let item of items.items) {
          const url = await item.getDownloadURL();
          const li = document.createElement("li");
          li.innerHTML = `<a href="${url}" target="_blank">${item.name}</a>`;
          fileList.appendChild(li);
        }
      } catch {
        fileList.innerHTML = "<li>Error loading files.</li>";
      }
    }
  </script>

</body>
</html>